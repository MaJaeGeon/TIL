# Middleware

미들웨어는 요청과 응답을 처리하기위해 파이프라인에서 조립되는 컴포넌트(미들웨어)이다.  
미들웨어는 아래와 같은 역할을 수행할 수 있다.  
처리한 요청을 파이프라인에 있는 다른 컴포넌트로 전달할지 말지를 결정한다.  
파이프라인의 다음 컴포넌트가 호출되기 이전과 이후에 특정동작을 수행할 수 있다.  
요청 델리게이트 (Request Delegate)는 요청 파이프라인을 구축하는데 사용되며, 각각의 HTTP 요청을 처리한다.  
요청 델리게이트는 Run, Map, Use 라는 확장 메서드를 사용하여 구성된다.  
각각의 요청 델리게이트는 인라인 미들웨어라고 불리는 익명 메서드로 지정되거나 클래스로 정의될 수 있다.  
이러한 클래스와 인라인 무명 메서드는 미들웨어라고하며 미들웨어 컴포넌트라고 부르기도한다.  
요청 파이프라인의 각 미들웨어 컴포넌트는 파이프라인의 다음 컴포넌트를 호출하거나  
파이프라인의 호출체인을 중단하고 빠져나가는 단락 (short-circuiting) 역할을 담당한다.  
미들웨어가 단락되는 경우, 미들웨어에서 더이상 요청을 처리하지 못하도록하기 때문에 터미널 미들웨어라고 부른다.  

### IApplicationBuilder로 미들웨어 파이프라인 만들기

ASP.Net Core 요청 파이프라인은 일련의 요청 델리게이트로 구성되며 차례로 호출된다.  
아래의 다이어그램은 그 개념을 보여주며, 스레드의 실행은 검은색 화살표를 따라간다.  
![middleware_pipeline](https://docs.microsoft.com/ko-kr/aspnet/core/fundamentals/middleware/index/_static/request-delegate-pipeline.png?view=aspnetcore-3.1)  
각 델리게이트는 다음 델리게이트의 이전과 이후에 작업을 수행할 수 있다.  
예외를 처리하는 델리게이트는 파이프라인의 이후 단계에서 발생하는 예외를  
잡을 수 있도록 파이프라인의 초기에 호출되어야 한다.  
가장 간단한 방법은 모든 요청을 처리하는 단일 요청 델리게이트를 사용하는것이다.  
이 경우 실제 요청 파이프라인에는 포함되지 않지만, 단일 익명 메서드가 모든 HTTP 요청에 대한 반응에 호출된다.  